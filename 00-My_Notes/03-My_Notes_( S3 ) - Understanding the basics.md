# S3 | Understanding the basics
---

## S3 | Module Introduction
---
### Lecture Snapshots
<img src="./assets/S3/1.png" alt="packages" width ="800"/> 

## S3 | How The Web Works 
---
### Lecture Snapshots
<img src="./assets/S3/2.png" alt="packages" width ="800"/>
<img src="./assets/S3/3.png" alt="packages" width ="800"/>

## S3 | Creating a Node Server
---
### Lecture Snapshots
<img src="./assets/S3/4.png" alt="packages" width ="800"/>

#### importing the global module
<img src="./assets/S3/5.png" alt="packages" width ="400"/>

For importing local modules created by yourself you have to add `"/"(absolute path)` or `"./"(relative path)`.

#### creating a server
<img src="./assets/S3/6.png" alt="packages" width ="800"/>

A request listener is a function that will execute for every incoming request. It recieves 2 arguments: **request, response.**
<img src="./assets/S3/7.png" alt="packages" width ="800"/>
<img src="./assets/S3/8.png" alt="packages" width ="800"/>


This function will always be executed for all requests reaching our server.
<img src="./assets/S3/9.png" alt="packages" width ="400"/>

You can also pass an anonymous function.
<img src="./assets/S3/10.png" alt="packages" width ="400"/>

ES6
<img src="./assets/S3/11.png" alt="packages" width ="400"/>

console the req 
<img src="./assets/S3/12.png" alt="packages" width ="800"/>

#### one important part is missing 

this function only returns the server. But we do not know the location of the server
<img src="./assets/S3/13.png" alt="packages" width ="800"/>

The `listen()` method starts a process that keeps on listening for incoming requests. It takes as argument the **port and the hostname**
<img src="./assets/S3/14.png" alt="packages" width ="800"/>

look at the cursor. The file execution did not finish. Its listening for requests.
<img src="./assets/S3/15.png" alt="packages" width ="800"/>

#### see the server in action
<img src="./assets/S3/16.png" alt="packages" width ="400"/>
your req is logged.
<img src="./assets/S3/17.png" alt="packages" width ="800"/>


## S3 | The Node Lifecycle & Event Loop
---
### Lecture Snapshots
<img src="./assets/S3/18.png" alt="packages" width ="800"/>
<img src="./assets/S3/19.png" alt="packages" width ="800"/>
<img src="./assets/S3/20.png" alt="packages" width ="800"/>
<img src="./assets/S3/21.png" alt="packages" width ="800"/>
The process hard exited and gave the control back to the terminal.
<img src="./assets/S3/22.png" alt="packages" width ="800"/>



## S3 | Understanding Requests
---
### Lecture Snapshots
The req is generated by the nodejs server once we visit the url `localhost:3000`.
<img src="./assets/S3/23.png" alt="packages" width ="800"/>

lets output only few properties of the req object.
<img src="./assets/S3/24.png" alt="packages" width ="800"/>

the url, method and header. url is anything after our localhost.
<img src="./assets/S3/25.png" alt="packages" width ="800"/>

## S3 | Sending Responses
---
### Lecture Snapshots

#### the response object needs to be filled with data

Like we can set the header types.
<img src="./assets/S3/26.png" alt="packages" width ="800"/>

Write some data to the response (html) line by line
<img src="./assets/S3/27.png" alt="packages" width ="800"/>

After finishing the html code you have to end the response by writing end(). We must not write anymore after end(). Otherwise we will get an error .
<img src="./assets/S3/28.png" alt="packages" width ="800"/>

#### output
<img src="./assets/S3/29.png" alt="packages" width ="800"/>
<img src="./assets/S3/30.png" alt="packages" width ="800"/>
<img src="./assets/S3/31.png" alt="packages" width ="800"/>

## S3 | Routing Requests
---
### Objective 
Route different urls to different pages 

### Lecture Snapshots
Lets write some case statements on the url of the request.
<img src="./assets/S3/32.png" alt="packages" width ="800"/>

Send a **POST** request to '/message'
<img src="./assets/S3/33.png" alt="packages" width ="800"/>

A name attribute in the form input elements causes the request sent to the server to have that as request data .
<img src="./assets/S3/34.png" alt="packages" width ="800"/>
<img src="./assets/S3/35.png" alt="packages" width ="800"/>

So we render this html code for `url = "/"`
<img src="./assets/S3/36.png" alt="packages" width ="800"/>

A `return` statement is needed to end the code execution of the listener function so that after returning the response with a particular html the next piece of code that might return some other html is not executed.
<img src="./assets/S3/37.png" alt="packages" width ="800"/>
<img src="./assets/S3/38.png" alt="packages" width ="400"/>

Enter something and click Send
<img src="./assets/S3/39.png" alt="packages" width ="800"/>

We see 
<img src="./assets/S3/40.png" alt="packages" width ="800"/>

since the url is now `/message`
<img src="./assets/S3/41.png" alt="packages" width ="800"/>

So this code runs
<img src="./assets/S3/42.png" alt="packages" width ="800"/>

## S3 | Redirecting Requests
---
### Lecture Snapshots
Lets do something when the send button is clicked
1. Redirect user to the page with `url="/"`.
2. Write a new file with the message entered by the user on the root home page 

<img src="./assets/S3/43.png" alt="packages" width ="800"/>
<img src="./assets/S3/44.png" alt="packages" width ="800"/>

write file with `writefileSync`. Will explain later.
<img src="./assets/S3/45.png" alt="packages" width ="800"/>
<img src="./assets/S3/46.png" alt="packages" width ="800"/>

Redirection Code with some js object using writeHead
<img src="./assets/S3/47.png" alt="packages" width ="800"/>

Or you can do this separately by setting the statusCode = 302 which is for redirection and set the Header (Location) to '/'. Then you have to end the res so that the later codes are not executed
<img src="./assets/S3/48.png" alt="packages" width ="800"/>

We got redirected to `localhost/` after we clicked send in the form.
<img src="./assets/S3/49.png" alt="packages" width ="800"/>

We get the messgae.text file with DUMMY inside.
<img src="./assets/S3/50.png" alt="packages" width ="800"/>

Lets parse the data user sent us and write that data instead of DUMMY.

## S3 | Parsing Request Bodies
---
### Lecture Snapshots
* There is nothing like request.data. 
* Instead the incoming data is sent as a stream of data. For example a large file uploaded to the server comes in smaller chunks so that the server can start processing those chunk before the whole file gets uploaded.
* There is a connected concept called buffer.
* Request is read in chunks by node
<img src="./assets/S3/51.png" alt="packages" width ="800"/>

* Buffers are required to work with such chunks of flowing data. It acts as **bus stop** for the chunks so that you are able to work with them before releasing them.
<img src="./assets/S3/53.png" alt="packages" width ="800"/>

* Register an event listener in the req called `"on"` and listen for a `"data"` event. 
<img src="./assets/S3/54.png" alt="packages" width ="800"/>

* The data event will be fired whenever a new chunk is ready to be read. The 2nd argument is the function that should be executed for every data event. 
<img src="./assets/S3/55.png" alt="packages" width ="800"/>

* This listener receives a chunk of data. Lets log the chunk and see whats inside.
<img src="./assets/S3/57.png" alt="packages" width ="800"/>

* We need to register another event listener, `end`. This will be called when the data parsing /incoming request parsing is done. Now all chunks are stored in the body.
* To work with these chunks we need to use `Buffer`, our **bus stop**. Then we need to concat the body to it and convert to string and console.log the `parseBbody`.
<img src="./assets/S3/58.png" alt="packages" width ="800"/>

* Output
<img src="./assets/S3/59.png" alt="packages" width ="800"/>

* Store the input in our file
<img src="./assets/S3/60.png" alt="packages" width ="800"/>


## S3 | Understanding Event Driven Code Execution
---
### Lecture Snapshots
* Wrong way of setting up the response if we want that the event listener should affect the response
<img src="./assets/S3/61.png" alt="packages" width ="800"/>

* Correct way. Put all the code inside the event listener.
<img src="./assets/S3/62.png" alt="packages" width ="800"/>

* In nodejs we can register code which will fire at a later time but this will not block the codes immediately placed after it. Its non-blocking.
<img src="./assets/S3/63.png" alt="packages" width ="800"/>

* To avoid execution of the code after listener we need to return.
<img src="./assets/S3/64.png" alt="packages" width ="800"/> 

## S3 | Blocking and Non-Blocking Code
---
### Objective
What is wrong with the `writeFileSync` here !
<img src="./assets/S3/65.png" alt="packages" width ="800"/> 

### Lecture Snapshots
* **`writeFileSync`** is a synchronous method which will block code until the file is created.
* Instead we should use `writeFile` which is synchronous in nature and does not block the code. It also accepts a 3rd argument which is a callabck, the function that should be executed after the file writing is done. The event handler receives an **error** object in case there is an error.
<img src="./assets/S3/66.png" alt="packages" width ="800"/> 

* Lets move the response code inside the event handler because we want this to execute only when we finish writing the file.
<img src="./assets/S3/67.png" alt="packages" width ="800"/> 

So nodejs is non-blocking. It tells the OS (milti-threaded), do this and do that and continues execution. Once the OS finishes execution it executes the callback which was an event handler registered.

```javascript
    // 1 - save the info entered in the form in a file
      //[Blocking]
      fs.writeFileSync("message.txt", data); // writeFileSync operates sequentially and blocks the following code execution. Instead use "writeFile" func 

      // writeFile executes asynchronously and does not block code until file is written to disc. It also accepts a 3rd argument which is 
      //[Non-Blocking]
      fs.writeFile('message.txt', data, (error) => {
        // 2 - redirect the user to url = '/'
        res.statusCode = 302; // redirection code
        res.setHeader("Location", "/"); // redirection url
        return res.end(); // return from the function after res prepared.
      });
```

## S3 | Node.js - Looking Behind the Scenes
---
### Objective
How Nodejs manages its work!

### Lecture Snapshots
* Nodejs uses only one `SINGLE THREAD` (a process in your OS).
* How is it then able to handle multiple requests if its single threaded.
* The `EVENT LOOP` will only handle Callbacks with fast finishing code.
* Instead out file system operation and other long taking operations are sent to a `WORKER POOL`. This worker pool does the heavy lifting and can have `MULTIPLE THREADS`. This is close connected to the OS we work on. This is `DETACHED` from the nodejs code, event loop and from the event loop. Once the worker is done it will trigger the `CALLBACK` for that operation (e.g readFile, wrtiteFile) which will be picked up by the event loop.
<img src="./assets/S3/68.png" alt="packages" width ="800"/> 

* **Event Loop (Advanced)**
<img src="./assets/S3/69.png" alt="packages" width ="800"/> 

## S3 | Using the Node Modules System
---
### Objective
Improving our code with multiple files.

### Lecture Snapshots
* Create routes.js
  <img src="./assets/S3/70.png" alt="packages" width ="800"/> 

* Cut all `if..else` code from the `app.js` and paste to `routes.js`
  <img src="./assets/S3/71.png" alt="packages" width ="800"/> 

* `app.js`
  <img src="./assets/S3/72.png" alt="packages" width ="800"/> 

* `routes.js`
  * Create a `requestHandler()` function in the routes.js file which will be    connected to the `app.js` file.
    <img src="./assets/S3/74.png" alt="packages" width ="800"/> 
  
  * **Export** the `requestHandler()` method so that app.js can use it
     <img src="./assets/S3/75.png" alt="packages" width ="800"/> 
  
  * **Import** in app.js
      <img src="./assets/S3/76.png" alt="packages" width ="800"/> 

  * Other syntax to export many things
      <img src="./assets/S3/77.png" alt="packages" width ="800"/> 
      <img src="./assets/S3/79.png" alt="packages" width ="800"/> 
      short cut supported by nodejs..you can remove the module
      <img src="./assets/S3/80.png" alt="packages" width ="800"/> 

  * Other syntax to import many things
      <img src="./assets/S3/78.png" alt="packages" width ="800"/> 

### Lets split the code into multiple files and use them together. Here we create a routes.js file to handle the routing.

```javascript
//[routes.js]
const requestHandler = (req, res) => {
    if (url === "/") {

    }
    if (url === "/message" && method === "POST") {

    }
}
/**
 * module.exports is a global object exposed by node js which has a exports property.
 * Assigning something e.g function or object to it allows node.js to use the registered object
 * by importing it whereever it is required.
*/
module.exports = requestHandler;
```

```javascript
//[App.js]
const http = require("http");

const routes = require('./routes'); // will cause node.js to look for any module.exports in the path, grab that and assign that to const routes.

const server = http.createServer(routes);
  
server.listen(3001); // servers starts listening to incoming requests.
```

### Exporting multiple things 

```javascript 
//[Way-1]
module.exports = {
    handler: requestHandler,
    someText: 'Some hard coded text'
}

//[Way-2]
module.exports.handler = requestHandler;
module.exports.someText = 'some hard coded text';

```

## S3 | Wrap up
---
### Objective

### Lecture Snapshots
<img src="./assets/S3/81.png" alt="packages" width ="800"/>

## S3 | Useful Resources & Links
Useful resources:

[Official Node.js Docs:](https://nodejs.org/en/docs/guides/)

[Full Node.js Reference (for all core modules): ](https://nodejs.org/dist/latest/docs/api/)

[More about the Node.js Event Loop: ](https://nodejs.org/en/docs/guides/event-loop-timers-and-nexttick/)

[Blocking and Non-Blocking Code: ](https://nodejs.org/en/docs/guides/dont-block-the-event-loop/)